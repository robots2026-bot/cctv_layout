# 模拟网关设备推送调试

## 核心目标
1. 为后端 `POST /device-sync` 提供前端可视化调试入口，避免手写 `curl` 或 Postman。
2. 支持录入项目通信 ID、网关标识、采样时间及多台设备的状态/指标，实时校验数据完整性。
3. 通过实时 JSON 预览了解最终请求内容，发送后展示响应或错误，便于快速验证同步流程。

## 页面入口
- 顶部导航新增“模拟网关”按钮，对应路由 `/device-sync/mock`。该页面不展示项目侧栏，保证屏幕空间用于表单与调试反馈。

## 表单结构
1. **网关信息区**：通信 ID（0-255）、网关 MAC、网关 IP（可选）、采样时间（ISO8601，可一键填充当前时间）。
2. **设备列表区**：
   - 支持动态增删设备卡片，默认主状态为 `online`。
   - 字段覆盖名称、类型、MAC、IP、型号、主状态、附加状态（逗号分隔）、延迟、丢包率、自定义指标 JSON。
   - 当类型选择为“网桥”时，必须同时指定角色 `AP`（主站）或 `ST`（从站），生成的 payload 会写入 `bridgeRole`。
   - 自定义指标需是对象结构，校验失败会在提示区给出错误信息。
3. **辅助操作**：提供“填充示例数据”“清空表单”按钮便于快速演示与复用模板。

## 校验与预览
- 右侧面板实时展示 JSON 预览及校验结果。未通过校验时，发送按钮会禁用并列出所有问题点（通信 ID 范围、MAC 缺失、JSON 解析失败等）。
- 预览采用 `JSON.stringify(payload, null, 2)` 与后端交互格式保持一致，便于复制或排查。

## 发送与反馈
1. 点击“发送到后端”后调用 `postDeviceSync`（`apiClient.post('/device-sync', payload)`），记录耗时并展示成功响应。
2. 如后端返回 4xx/5xx，将错误体以 JSON 形式显示，方便定位后端校验失败原因。
3. 提交过程中按钮显示“发送中…”，防止重复点击。

## 自测流程
1. 启动环境：`docker compose up -d postgres redis backend frontend`。
2. 访问前端 `http://localhost:5173`，通过导航进入“模拟网关”页面。
3. 填充示例数据，确认 JSON 预览与文档示例一致，校验区提示可发送。
4. 将示例中的网桥切换 AP/ST 角色并发送，请求体应携带 `bridgeRole`，后端返回 `processed: 1`。
5. 在后端开启调试日志，点击“发送到后端”，观察响应体是否记录 `processed` 数量及失败列表。
6. 修改某台设备的 MAC 为重复值或输入非法 JSON，确认校验区准确给出错误并禁用发送。
7. 清空表单后重新录入真实通信 ID 与设备信息，验证再次提交成功。
