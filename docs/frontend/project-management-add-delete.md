# 项目列表新增/删除设计

## 背景
- 统一通信 ID（0-255）管理工地项目，并确保新增/删除/归档流程安全、可追溯。
- 项目管理页面以快速定位和单条操作为核心，不再提供批量动作。

## 前端界面
- **页面入口**：`/projects/manage`，仅管理员与维护者可访问。整体结构为“左侧筛选栏 + 右侧列表 + 详情抽屉”。
- **筛选栏**：
  - 搜索框支持名称或通信 ID 模糊匹配；
  - 筛选项：状态（active/archived/deleted）、施工阶段、地区、通信 ID 范围（0-255 可选最小/最大）；
  - 排序：名称 A-Z/Z-A、最近更新、最早更新；可选择是否包含已删除项目；
  - 所有筛选与排序变更即时触发刷新。
- **列表区**：
  - 顶部展示总项目、活跃项目、归档/删除数量三个指标卡片，右侧保留“新建项目”按钮；
  - 表格列：通信 ID、项目名称、地区、施工阶段、摄像头数、布局数、最近更新时间、状态、操作；
  - 行点击打开右侧详情抽屉，操作列提供“打开布局工作台 / 归档 / 恢复 / 删除”等动作；
  - 不再提供批量复选框与导出能力。
- **详情抽屉**：
  - 展示基础信息（通信 ID、地区、计划上线、更新时间等）、布局/设备统计、最近 5 条布局以及成员（只暴露姓名与邮箱）；
  - 底部操作：打开布局工作台（若缺省则自动生成默认布局）、归档、恢复（针对归档/删除状态）、删除。
- **新建项目抽屉**：
  - 表单字段按“基础信息 / 施工计划 / 协作设置”分组，通信 ID 仅允许 0-255 的唯一整数；
  - 前端本地校验后提交，若后端返回 409（通信 ID 冲突）在字段处展示错误提示。
- **删除确认弹窗**：
  - 需输入项目名称确认，保留“同时归档布局”“保留设备映射”选项；
  - 删除后 push 通知，可在 30 天内通过恢复接口还原。

## 后端设计
- **REST API（`ProjectsController`）**：
  - `GET /api/projects` 新增 `orderBy=name|updatedAt`、`order=asc|desc`、`codeGte`、`codeLte` 参数；返回分页数据与 totals；
  - `GET /api/projects/:id` 返回详情（含成员、近期布局、统计数据）；
  - `POST /api/projects` 仅接受 `code` 为 0-255 的 `smallint`，冲突抛 409；
  - `PATCH /api/projects/:id` 支持更新信息或切换状态（active/archived/deleted）；
  - `DELETE /api/projects/:id`、`POST /api/projects/:id/restore` 保持软删除语义，写入操作日志；
  - 批量接口已移除，由前端单条调用完成。
- **服务内部**：
  - 列表查询统一使用 QueryBuilder 组合筛选、排序、通信 ID 区间；
  - 详情查询附带成员（仅返回 id/name/email）与最近布局记录，避免前端 N+1 请求；
  - 删除/归档仍写入 `activity_logs`，并通过 `projects.updated` 广播供前端刷新。

## 数据库与迁移
- `projects.code` 改为 `SMALLINT UNIQUE`（范围 0-255），保留 `layout_count_cache`、`device_count_cache` 等字段；
- 迁移 `20241014120000` 继续负责扩充字段，新增 `20241014124500-ProjectCommunicationIdNumeric`：
  1. 检查项目数量是否 ≤256；
  2. 引入临时列 `new_code`（smallint），按创建时间重新分配通信 ID；
  3. 删除旧 `code` 字段，重命名并恢复唯一约束。
- `project_members`、`activity_logs` 表结构维持不变，仅沿用原有枚举和详情记录。

## 实施建议
1. 先合并后端迁移与接口更新，再落地前端筛选/详情抽屉；
2. 在 backend 容器执行 `npm run migration:run`，确保两个迁移均已应用；
3. 编写测试覆盖：通信 ID 冲突、筛选/排序组合、删除后恢复与详情接口。
