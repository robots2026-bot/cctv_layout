# AGENTS 指南

## 项目定位
- 本仓库用于构建工地 CCTV 与网桥快速布局平台，必须支持设备自动扫描、画布拖拽连线及背景图透明度调节等核心功能。

## 工作流
1. 新任务请在 issue 中澄清需求与交互原型。
2. 开发前更新或复核 `DESIGN_PLAN.md` 中的架构与模块划分，必要时提交设计增量。
3. 所有改动需创建独立分支，完成自测后发起 PR，并包含摘要、测试命令、风险评估。

## 文档约定
- `DESIGN_PLAN.md` 为架构与功能真源，变更需同步更新相关章节（架构、模块、数据模型、风险等）。
- 需求或流程更新请补充序号化条目，保持中文简洁描述，必要时附上流程图链接。

## 前端规范
- 技术栈：React + TypeScript + Zustand 状态管理，Tailwind CSS 构建界面，画布使用 Konva.js（通过 react-konva）。
- 将状态划分为项目上下文、画布状态、实时流；确保 200+ 设备仍可流畅操作。
- 与后端交互采用 REST（配置）+ WebSocket（实时）；禁止在组件中直接操作 DOM。

## 后端规范
- 唯一后端框架选型为 NestJS（TypeScript），模块化拆分设备接入、布局管理、文件与推送服务。
- 数据库使用 PostgreSQL，实时状态与消息队列使用 Redis，并通过 WebSocket 网关推送实时信息。
- 设备同步需实现去重、状态更新与重试；布局保存必须生成版本快照并广播。

## 测试与质量
- 为设备同步、协同编辑、画布导出等关键流程编写自动化测试。
- 性能基准：画布拖拽延迟、WebSocket 推送延迟 < 2 秒；失败重试与幂等性需覆盖单测/集成测试。
- 运行 linters、单元测试、端到端测试后才能合并。

## 运维与安全
- 所有服务需提供 Dockerfile，并导出 Prometheus 指标。
- 通过 HTTPS 与 Token 鉴权保护接口，敏感信息脱敏或加密存储。
- 记录用户操作日志，重要动作需包含项目/用户上下文。

## 风险管理
- 遇到第三方接口不稳定，请使用模拟数据并实现指数回退重试。
- 持续评估画布性能与多人协作冲突，必要时引入虚拟化与乐观锁/CRDT。
