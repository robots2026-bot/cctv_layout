# CCTV 布局系统方案设计

## 1. 总体目标
构建一个可在工地现场快速完成 CCTV 与网桥部署规划的 Web 应用，实现设备扫描、布局展示、手动拖拽定位以及背景图透明度调整等核心需求。

## 2. 系统架构
- **前端**：
  - 技术选型：React + TypeScript + Zustand（或 Redux Toolkit）用于状态管理，Tailwind CSS 提升样式开发效率。
  - 布局编辑：采用 Konva.js 或 Fabric.js 支持 Canvas 拖拽、缩放、连接线绘制。
  - 通信：通过 WebSocket 接收实时设备扫描推送，REST API 执行常规数据管理操作。
- **后端**：
  - 技术选型：Node.js（NestJS 框架）或 Python（FastAPI），根据团队经验决定。
  - 功能模块：
    - 设备发现与接入模块：从网络扫描服务或第三方平台获取设备列表。
    - 布局管理模块：存储项目、平面图、设备位置及连线。
    - 文件服务：处理背景图上传、存储与缩略图生成。
    - 推送服务：通过 WebSocket 将最新设备状态推送至前端。
  - 数据库：PostgreSQL 存储结构化数据，Redis 缓存实时设备状态。

## 3. 核心功能模块拆分
1. **项目管理**
   - 创建/编辑/删除工地项目。
   - 项目级权限控制与协作。
2. **设备扫描与同步**
   - 现场有扫描，定时推送平台设备列表及其状态。
   - 设备信息标准化（类型、IP、状态、厂商）。
   - 重复设备判定策略与状态更新。
3. **布局画布**
   - 背景图导入、缩放、透明度调整。
   - 设备元素拖拽放置、旋转、属性编辑。
   - 连线工具：支持自由连线、自动吸附端口。
   - 图层管理：显示/隐藏不同设备类型、网桥、辅助标记、有线连接、无线连接。
4. **实时更新与协作**
   - 多用户同时编辑的锁定/合并策略。
   - 实时设备状态展示（在线/离线、信号强度）。
5. **数据存储与版本控制**
   - 布局快照与历史版本保存。
   - 导出布局（PNG、PDF、JSON 配置）。
6. **权限与审计**
   - 登录认证、角色权限（管理员、工程师、访客）。
   - 操作日志记录。

## 4. 关键流程
1. **设备接入流程**：扫描设备将结果推送的平台后端 → 后端设备同步服务 → 数据库存储/更新 → WebSocket 推送到前端 → 前端设备列表更新。
2. **布局编辑流程**：用户选中设备 → 拖拽到画布 → 前端生成布局 JSON → 后端保存 → 版本记录与实时广播。
3. **背景图管理流程**：用户上传 → 后端文件服务存储 → 前端加载 → 用户调整透明度（存储在布局配置中）。

## 5. 数据模型草案
- `projects`：id、name、location、created_at、updated_at。
- `devices`：id、project_id、type、name、ip、status、metadata、last_seen_at。
- `layouts`：id、project_id、name、background_image_url、background_opacity、current_version_id。
- `layout_versions`：id、layout_id、version_no、elements_json、connections_json、created_by、created_at。
- `users`：id、name、email、password_hash、role。
- `activity_logs`：id、project_id、user_id、action、details、created_at。

## 6. 非功能性需求
- **性能**：画布保证 200+ 设备流畅拖拽；WebSocket 推送延迟 < 2s。
- **可靠性**：设备同步失败自动重试，关键操作具备幂等性。
- **安全**：全站 HTTPS，Token 鉴权，设备敏感信息脱敏处理。
- **可运维性**：Docker 化部署，Prometheus + Grafana 监控。

## 7. 项目里程碑建议
1. **需求确认阶段（1 周）**：细化设备类型、平台接口、用户角色需求。
2. **原型设计与技术选型（2 周）**：完成界面原型、组件选型、技术预研。
3. **基础功能开发（4 周）**：实现项目管理、设备同步、基础布局编辑。
4. **高级功能开发（3 周）**：实时协作、版本管理、导出能力。
5. **测试与部署（2 周）**：性能测试、安全测试、上线准备。

## 8. 风险与应对
- **设备平台接口不稳定**：预留模拟数据与重试机制。
- **画布性能瓶颈**：前期预研 Konva/Fabric 优化手段，采用虚拟化列表与图层管理。
- **多人协作冲突**：引入乐观锁或 CRDT 同步方案，确保数据一致性。
